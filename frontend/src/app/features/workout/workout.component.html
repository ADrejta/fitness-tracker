<app-page-container>
  @if (workoutService.hasActiveWorkout()) {
    <!-- Active Workout -->
    <div class="workout">
      <div class="workout__header">
        <div class="workout__info">
          <input
            type="text"
            class="workout__name-input"
            [value]="workoutService.activeWorkout()?.name"
            (change)="updateWorkoutName($event)"
            placeholder="Workout name"
          />
          <div class="workout__meta">
            <span class="workout__timer">{{ elapsedTime() }}</span>
            <span class="workout__stats">
              {{ completedSets() }} sets completed
            </span>
          </div>
          <button
            class="workout__notes-toggle"
            (click)="showNotes = !showNotes"
            [class.has-notes]="workoutService.activeWorkout()?.notes"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
            {{ showNotes ? 'Hide notes' : (workoutService.activeWorkout()?.notes ? 'Show notes' : 'Add notes') }}
          </button>
          @if (showNotes) {
            <textarea
              class="workout__notes-input"
              [value]="workoutService.activeWorkout()?.notes || ''"
              (input)="updateWorkoutNotes($event)"
              placeholder="Add workout notes..."
              rows="2"
            ></textarea>
          }
          <div class="workout__tags-row">
            @for (tag of workoutService.activeWorkout()?.tags ?? []; track tag) {
              <span class="workout-tag">
                {{ tag }}
                <button class="workout-tag__remove" (click)="removeTag(tag)" type="button">Ã—</button>
              </span>
            }
            <input
              class="workout-tag-input"
              [value]="tagInput"
              (input)="tagInput = $any($event.target).value"
              (keydown)="onTagInputKeydown($event)"
              placeholder="Add tag..."
              type="text"
            />
          </div>
        </div>
        <button class="workout__menu-btn" (click)="showWorkoutMenu = !showWorkoutMenu">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="1"></circle>
            <circle cx="12" cy="5" r="1"></circle>
            <circle cx="12" cy="19" r="1"></circle>
          </svg>
        </button>

        @if (showWorkoutMenu) {
          <div class="workout__menu">
            <button (click)="saveAsTemplate()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="3" y1="9" x2="21" y2="9"></line>
                <line x1="9" y1="21" x2="9" y2="9"></line>
              </svg>
              Save as template
            </button>
            <button class="workout__menu-danger" (click)="showCancelModal = true">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
              </svg>
              Cancel workout
            </button>
          </div>
        }
      </div>

      <!-- Exercise List -->
      <div
        class="workout__exercises"
        cdkDropList
        (cdkDropListDropped)="onExerciseDrop($event)"
      >
        @for (exercise of groupedExercises(); track exercise.id) {
          @if (exercise.isFirstInSuperset) {
            <div class="superset-label">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 12h16M4 6h16M4 18h16"></path>
              </svg>
              Superset
              <button class="superset-remove" (click)="removeSuperset(exercise.supersetId!)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
          }
          <div
            class="exercise-wrapper"
            cdkDrag
            [class.in-superset]="exercise.isInSuperset"
            [class.superset-first]="exercise.isFirstInSuperset"
            [class.superset-last]="exercise.isLastInSuperset"
            [class.superset-selected]="selectedExercises().includes(exercise.id)"
            (click)="toggleExerciseSelection(exercise.id, $event)"
          >
            <div class="exercise-drag-handle" cdkDragHandle>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="8" y1="6" x2="16" y2="6"></line>
                <line x1="8" y1="12" x2="16" y2="12"></line>
                <line x1="8" y1="18" x2="16" y2="18"></line>
              </svg>
            </div>
            <app-workout-exercise
              [exercise]="exercise"
              (setAdded)="addSet(exercise.id, $event)"
              (setUpdated)="updateSet(exercise.id, $event.setId, $event.updates)"
              (setCompleted)="completeSet(exercise.id, $event.setId, $event.updates)"
              (setRemoved)="removeSet(exercise.id, $event)"
              (exerciseRemoved)="removeExercise(exercise.id)"
            />
          </div>
        }
      </div>

      <!-- Superset Creation UI -->
      @if (selectedExercises().length >= 2) {
        <div class="superset-action">
          <app-button variant="secondary" (clicked)="createSupersetFromSelection()">
            <span class="superset-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 12h16M4 6h16M4 18h16"></path>
              </svg>
              Link {{ selectedExercises().length }} exercises as Superset
            </span>
          </app-button>
          <app-button variant="ghost" size="sm" (clicked)="clearSelection()">Cancel</app-button>
        </div>
      }

      <!-- Add Exercise Button -->
      <app-button
        [fullWidth]="true"
        variant="secondary"
        (clicked)="showExercisePicker = true"
      >
        <span class="add-exercise-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add Exercise
        </span>
      </app-button>

      <!-- Finish Button -->
      @if (workoutService.activeWorkout()?.exercises?.length) {
        <div class="workout__finish">
          <app-button
            [fullWidth]="true"
            variant="success"
            size="lg"
            (clicked)="showFinishModal = true"
          >
            Finish Workout
          </app-button>
        </div>
      }
    </div>
  } @else {
    <!-- No Active Workout -->
    <div class="no-workout">
      <app-empty-state
        title="No Active Workout"
        description="Start a new workout or choose a template to begin tracking."
      >
        <div empty-icon>
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M14.4 14.4 9.6 9.6"></path>
            <path d="M18.657 21.485a2 2 0 1 1-2.829-2.828l-1.767 1.768a2 2 0 1 1-2.829-2.829l6.364-6.364a2 2 0 1 1 2.829 2.829l-1.768 1.767a2 2 0 1 1 2.828 2.829z"></path>
            <path d="m21.5 21.5-1.4-1.4"></path>
            <path d="M3.9 3.9 2.5 2.5"></path>
            <path d="M6.404 12.768a2 2 0 1 1-2.829-2.829l1.768-1.767a2 2 0 1 1-2.828-2.829l2.828-2.828a2 2 0 1 1 2.829 2.828l1.767-1.768a2 2 0 1 1 2.829 2.829z"></path>
          </svg>
        </div>
        <div class="no-workout__actions">
          <app-button (clicked)="startEmptyWorkout()">Start Empty Workout</app-button>
        </div>
      </app-empty-state>

      @if (templateService.recentTemplates().length > 0) {
        <div class="templates-section">
          <h3>Or start from a template</h3>
          <div class="templates-list">
            @for (template of templateService.recentTemplates(); track template.id) {
              <app-card [interactive]="true" [compact]="true" (click)="startFromTemplate(template.id)">
                <div class="template-item">
                  <div class="template-item__info">
                    <h4>{{ template.name }}</h4>
                    <span>{{ template.exercises.length }} exercises</span>
                  </div>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                  </svg>
                </div>
              </app-card>
            }
          </div>
        </div>
      }
    </div>
  }

  <!-- Exercise Picker Modal -->
  <app-exercise-picker
    [isOpen]="showExercisePicker"
    (closed)="showExercisePicker = false"
    (exerciseSelected)="addExercise($event)"
  />

  <!-- Rest Timer -->
  <app-rest-timer #restTimer />

  <!-- Finish Workout Modal -->
  <app-modal
    [isOpen]="showFinishModal"
    title="Finish Workout?"
    [showFooter]="true"
    size="sm"
    (closed)="showFinishModal = false"
  >
    <div class="finish-modal">
      <p>Great work! Here's your workout summary:</p>
      <div class="finish-modal__stats">
        <div class="finish-modal__stat">
          <span class="finish-modal__stat-value">{{ workoutService.activeWorkout()?.exercises?.length || 0 }}</span>
          <span class="finish-modal__stat-label">Exercises</span>
        </div>
        <div class="finish-modal__stat">
          <span class="finish-modal__stat-value">{{ completedSets() }}</span>
          <span class="finish-modal__stat-label">Sets</span>
        </div>
        <div class="finish-modal__stat">
          <span class="finish-modal__stat-value">{{ settingsService.formatWeight(totalVolume(), false) }}</span>
          <span class="finish-modal__stat-label">{{ settingsService.weightUnit() }}</span>
        </div>
      </div>
    </div>
    <div modal-footer>
      <app-button variant="ghost" (clicked)="showFinishModal = false">Cancel</app-button>
      <app-button variant="success" (clicked)="finishWorkout()">Finish</app-button>
    </div>
  </app-modal>

  <!-- Cancel Workout Modal -->
  <app-modal
    [isOpen]="showCancelModal"
    title="Cancel Workout?"
    [showFooter]="true"
    size="sm"
    (closed)="showCancelModal = false"
  >
    <p>Are you sure you want to cancel this workout? All progress will be lost.</p>
    <div modal-footer>
      <app-button variant="ghost" (clicked)="showCancelModal = false">Keep Working</app-button>
      <app-button variant="danger" (clicked)="cancelWorkout()">Cancel Workout</app-button>
    </div>
  </app-modal>
</app-page-container>
