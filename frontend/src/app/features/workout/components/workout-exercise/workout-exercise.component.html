<div class="workout-exercise">
  <div class="workout-exercise__header">
    <div class="workout-exercise__info">
      <div class="workout-exercise__name-row">
        <h3 class="workout-exercise__name">{{ exercise.exerciseName }}</h3>
        @if (exercise.notes) {
          <span class="workout-exercise__notes-indicator" title="{{ exercise.notes }}">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
          </span>
        }
      </div>
      <div class="workout-exercise__tags">
        @for (muscle of muscleGroups.slice(0, 2); track muscle) {
          <app-badge [size]="'sm'" [variant]="'default'">
            {{ exerciseService.getMuscleGroupLabel(muscle) }}
          </app-badge>
        }
      </div>
    </div>
    <button class="workout-exercise__menu" (click)="showMenu = !showMenu">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="1"></circle>
        <circle cx="12" cy="5" r="1"></circle>
        <circle cx="12" cy="19" r="1"></circle>
      </svg>
    </button>

    @if (showMenu) {
      <div class="workout-exercise__dropdown">
        @if (!isCardio && !isCarry) {
          <button (click)="openWarmupCalculator()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path>
            </svg>
            Warm-up Calculator
          </button>
        }
        <button (click)="toggleNotes()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
          </svg>
          Notes
        </button>
        <button (click)="removeExercise()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18"></path>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
            <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
          Remove exercise
        </button>
      </div>
    }

    @if (showWarmupCalculator()) {
      <div class="warmup-calculator">
        <div class="warmup-calculator__header">
          <h4>Warm-up Calculator</h4>
          <button class="warmup-calculator__close" (click)="closeWarmupCalculator()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="warmup-calculator__input">
          <label>Working Weight</label>
          <div class="warmup-calculator__input-row">
            <input
              type="number"
              [ngModel]="workingWeight()"
              (ngModelChange)="workingWeight.set($event)"
              placeholder="0"
              min="0"
            />
            <span class="warmup-calculator__unit">{{ settingsService.weightUnit() }}</span>
          </div>
        </div>
        @if (warmupSets().length > 0) {
          <div class="warmup-calculator__preview">
            <label>Suggested Warm-ups</label>
            <div class="warmup-calculator__sets">
              @for (set of warmupSets(); track $index) {
                <div class="warmup-calculator__set">
                  <span class="warmup-calculator__set-num">{{ $index + 1 }}.</span>
                  <span class="warmup-calculator__set-weight">
                    {{ set.label === 'Bar' ? 'Bar' : '' }} ({{ set.weight }} {{ settingsService.weightUnit() }})
                  </span>
                  <span class="warmup-calculator__set-reps">× {{ set.reps }} reps</span>
                </div>
              }
            </div>
          </div>
          <button class="warmup-calculator__add" (click)="addWarmupSets()">
            Add {{ warmupSets().length }} Warm-up Set{{ warmupSets().length > 1 ? 's' : '' }}
          </button>
        } @else if (workingWeight() > 0) {
          <div class="warmup-calculator__empty">
            <p>No warm-ups needed - weight is at or below bar weight.</p>
          </div>
        }
      </div>
    }
  </div>

  <div class="workout-exercise__sets">
    <div class="workout-exercise__sets-header">
      <span>Set</span>
      <span class="workout-exercise__sets-header-previous">Previous</span>
      <span class="workout-exercise__sets-header-main">{{ isCardio ? 'Distance / Duration / kcal' : isCarry ? 'Weight × Distance' : 'Weight × Reps' }}</span>
      <span></span>
    </div>

    @for (set of exercise.sets; track set.id) {
      <app-set-row
        [set]="set"
        [previousSet]="getPreviousSetData(set)"
        [progressionSuggestion]="progressionSuggestion"
        [isCardio]="isCardio"
        [isBodyweight]="isBodyweight"
        [isCarry]="isCarry"
        (setUpdated)="onSetUpdated(set.id, $event)"
        (setCompleted)="onSetCompleted(set.id, $event)"
        (setUncompleted)="onSetUncompleted(set.id)"
        (setDeleted)="setRemoved.emit(set.id)"
      />
    }
  </div>

  @if (showNotes) {
    <div class="exercise-notes-panel">
      <textarea
        class="exercise-notes-panel__input"
        [ngModel]="notesValue()"
        (ngModelChange)="notesValue.set($event)"
        placeholder="Add exercise notes (e.g. keep elbows tucked)..."
        rows="3"
      ></textarea>
      <button class="exercise-notes-panel__save" (click)="saveNotes()">Save</button>
    </div>
  }

  <div class="workout-exercise__add-row">
    <button class="workout-exercise__add-set" (click)="addSet()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      Add Set
    </button>
    @if (!isCardio && !isCarry) {
      <button class="workout-exercise__add-warmup" (click)="addWarmupSet()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path>
        </svg>
        Add Warm-up
      </button>
    }
  </div>
</div>
