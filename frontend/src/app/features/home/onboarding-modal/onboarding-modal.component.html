<app-modal
  [isOpen]="isOpen"
  [showHeader]="false"
  [closeOnOverlayClick]="false"
  [closeOnEscape]="false"
  size="sm"
>
  <!-- Dismiss button -->
  <button class="onboarding__dismiss" (click)="onDismiss()" aria-label="Skip onboarding">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="18" y1="6" x2="6" y2="18"></line>
      <line x1="6" y1="6" x2="18" y2="18"></line>
    </svg>
  </button>

  <!-- Slides wrapper -->
  <div class="onboarding__slides">
    <div
      class="onboarding__slide"
      [class.onboarding__slide--enter-forward]="slideDirection() === 'forward'"
      [class.onboarding__slide--enter-back]="slideDirection() === 'back'"
    >

      <!-- Step icon -->
      <div class="onboarding__icon">
        @switch (currentStepData.icon) {
          @case ('dumbbell') {
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M14.4 14.4 9.6 9.6"></path>
              <path d="M18.657 21.485a2 2 0 1 1-2.829-2.828l-1.767 1.768a2 2 0 1 1-2.829-2.829l6.364-6.364a2 2 0 1 1 2.829 2.829l-1.768 1.767a2 2 0 1 1 2.828 2.829z"></path>
              <path d="m21.5 21.5-1.4-1.4"></path>
              <path d="M3.9 3.9 2.5 2.5"></path>
              <path d="M6.404 12.768a2 2 0 1 1-2.829-2.829l1.768-1.767a2 2 0 1 1-2.828-2.829l2.828-2.828a2 2 0 1 1 2.829 2.828l1.767-1.768a2 2 0 1 1 2.829 2.829z"></path>
            </svg>
          }
          @case ('play') {
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10"></circle>
              <polygon points="10 8 16 12 10 16 10 8"></polygon>
            </svg>
          }
          @case ('check') {
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M9 11l3 3L22 4"></path>
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
          }
          @case ('barbell') {
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="2" y="6" width="20" height="12" rx="2"></rect>
              <line x1="6" y1="6" x2="6" y2="18"></line>
              <line x1="18" y1="6" x2="18" y2="18"></line>
              <line x1="2" y1="12" x2="22" y2="12"></line>
            </svg>
          }
          @case ('chart') {
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <line x1="18" y1="20" x2="18" y2="10"></line>
              <line x1="12" y1="20" x2="12" y2="4"></line>
              <line x1="6" y1="20" x2="6" y2="14"></line>
              <line x1="2" y1="20" x2="22" y2="20"></line>
            </svg>
          }
          @case ('trophy') {
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
              <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
              <path d="M4 22h16"></path>
              <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
              <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
              <path d="M18 2H6v7a6 6 0 0 0 12 0V2z"></path>
            </svg>
          }
        }
      </div>

      <!-- Step title + body -->
      <div class="onboarding__content">
        <h2 class="onboarding__title">{{ currentStepData.title }}</h2>
        <p class="onboarding__body">{{ currentStepData.body }}</p>
      </div>

      <!-- Step 2: interactive mock start button -->
      @if (currentStep() === 2) {
        <div class="onboarding__demo">
          <button
            class="onboarding__mock-start"
            [class.onboarding__mock-start--loading]="workoutButtonState() === 'loading'"
            [class.onboarding__mock-start--done]="workoutButtonState() === 'done'"
            [disabled]="workoutButtonState() !== 'idle'"
            (click)="tapStartWorkout()"
          >
            @if (workoutButtonState() === 'idle') {
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="16"></line>
                <line x1="8" y1="12" x2="16" y2="12"></line>
              </svg>
              Start Workout
            } @else if (workoutButtonState() === 'loading') {
              <span class="onboarding__spinner"></span>
              Starting…
            } @else {
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Workout started!
            }
          </button>
          <p class="onboarding__demo-hint">Give it a tap ↑</p>
        </div>
      }

      <!-- Step 3: interactive mock set row -->
      @if (currentStep() === 3) {
        <div class="onboarding__demo">
          <div class="onboarding__mock-exercise">
            <span class="onboarding__mock-exercise-name">Bench Press</span>
          </div>
          <div class="onboarding__mock-set" [class.onboarding__mock-set--done]="setCompleted()">
            <span class="onboarding__mock-set-num">1</span>
            <div class="onboarding__mock-input-group">
              <input
                class="onboarding__mock-input"
                type="number"
                [ngModel]="mockWeight()"
                (ngModelChange)="mockWeight.set($event)"
                [disabled]="setCompleted()"
                aria-label="Weight"
              />
              <span class="onboarding__mock-unit">kg</span>
            </div>
            <span class="onboarding__mock-sep">×</span>
            <div class="onboarding__mock-input-group">
              <input
                class="onboarding__mock-input"
                type="number"
                [ngModel]="mockReps()"
                (ngModelChange)="mockReps.set($event)"
                [disabled]="setCompleted()"
                aria-label="Reps"
              />
              <span class="onboarding__mock-unit">reps</span>
            </div>
            <button
              class="onboarding__mock-check"
              [class.onboarding__mock-check--done]="setCompleted()"
              [disabled]="setCompleted()"
              (click)="tapCompleteSet()"
              aria-label="Complete set"
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </button>
          </div>
          <p class="onboarding__demo-hint">Edit the values, then tap ✓</p>
        </div>
      }

      <!-- Step 4: interactive plate calculator -->
      @if (currentStep() === 4) {
        <div class="onboarding__demo">
          <div class="onboarding__plate-controls">
            <div class="onboarding__plate-field">
              <label class="onboarding__plate-label">Target weight</label>
              <div class="onboarding__plate-input-row">
                <button class="onboarding__plate-stepper" (click)="plateDecrement()" [disabled]="plateCalculated()">−</button>
                <input
                  class="onboarding__mock-input onboarding__plate-input"
                  type="number"
                  [ngModel]="plateTargetWeight()"
                  (ngModelChange)="plateTargetWeight.set(+$event); plateCalculated.set(false); plateResults.set([])"
                  [disabled]="plateCalculated()"
                  aria-label="Target weight in kg"
                />
                <button class="onboarding__plate-stepper" (click)="plateIncrement()" [disabled]="plateCalculated()">+</button>
                <span class="onboarding__mock-unit" style="margin-left:2px">kg</span>
              </div>
            </div>

            @if (!plateCalculated()) {
              <button class="onboarding__mock-start" style="margin-top:0" (click)="calculatePlates()">
                Calculate plates
              </button>
            }
          </div>

          @if (plateCalculated()) {
            <div class="onboarding__plate-result">
              <p class="onboarding__plate-result-label">Per side — bar is {{ plateBarWeight }} kg</p>
              @if (plateResults().length === 0) {
                <p class="onboarding__demo-hint">Just the bar!</p>
              } @else {
                <div class="onboarding__plate-bar">
                  <!-- Bar shaft -->
                  <div class="onboarding__bar-shaft"></div>
                  <!-- Plates (largest first, closest to collar) -->
                  @for (plate of plateResults(); track plate.weight) {
                    @for (i of getRange(plate.count); track i) {
                      <div
                        class="onboarding__plate"
                        [style.background]="plate.color"
                        [style.height.px]="getPlateHeight(plate.weight)"
                        [style.width.px]="getPlateWidth(plate.weight)"
                        [title]="plate.weight + ' kg'"
                      ></div>
                    }
                  }
                  <!-- Collar -->
                  <div class="onboarding__collar"></div>
                </div>
                <div class="onboarding__plate-legend">
                  @for (plate of plateResults(); track plate.weight) {
                    <span class="onboarding__plate-chip" [style.background]="plate.color">
                      {{ plate.count }}× {{ plate.weight }} kg
                    </span>
                  }
                </div>
              }
            </div>
          }

          @if (!plateCalculated()) {
            <p class="onboarding__demo-hint">Tap Calculate to see the plates ↑</p>
          }
        </div>
      }

      <!-- Step 5: track progress — feature highlights -->
      @if (currentStep() === 5) {
        <div class="onboarding__demo onboarding__features">
          <div class="onboarding__feature-item">
            <div class="onboarding__feature-icon onboarding__feature-icon--pr">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                <path d="M4 22h16"></path>
                <path d="M18 2H6v7a6 6 0 0 0 12 0V2z"></path>
              </svg>
            </div>
            <div>
              <p class="onboarding__feature-title">Personal Records</p>
              <p class="onboarding__feature-body">Max weight, max reps, and estimated 1RM are tracked automatically on every workout.</p>
            </div>
          </div>
          <div class="onboarding__feature-item">
            <div class="onboarding__feature-icon onboarding__feature-icon--streak">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
              </svg>
            </div>
            <div>
              <p class="onboarding__feature-title">Streaks & Consistency</p>
              <p class="onboarding__feature-body">Your training streak and a 52-week heatmap show how consistent you've been.</p>
            </div>
          </div>
          <div class="onboarding__feature-item">
            <div class="onboarding__feature-icon onboarding__feature-icon--suggest">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="20" x2="12" y2="10"></line>
                <line x1="18" y1="20" x2="18" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="16"></line>
              </svg>
            </div>
            <div>
              <p class="onboarding__feature-title">Progression Suggestions</p>
              <p class="onboarding__feature-body">After a few sessions the app recommends when to increase weight or reps.</p>
            </div>
          </div>
        </div>
      }

    </div>
  </div>

  <!-- Step dots -->
  <div class="onboarding__dots">
    @for (s of stepRange; track s) {
      <div
        class="onboarding__dot"
        [class.onboarding__dot--active]="currentStep() === s"
        [class.onboarding__dot--past]="currentStep() > s"
        (click)="s < currentStep() ? prevStep() : null"
      ></div>
    }
  </div>

  <!-- Actions -->
  <div class="onboarding__actions">
    @if (currentStep() < totalSteps) {
      <button class="onboarding__skip" (click)="onDismiss()">Skip tour</button>
      @if (currentStep() === 1 || currentStep() === 4 || currentStep() === 5) {
        <app-button (clicked)="nextStep()">
          {{ currentStep() === 1 ? 'Get started →' : 'Next →' }}
        </app-button>
      } @else {
        <span class="onboarding__auto-hint">
          @if (currentStep() === 2) { Tap the button above to continue }
          @if (currentStep() === 3) { Complete the set to continue }
        </span>
      }
    } @else {
      <button class="onboarding__skip" (click)="onDismiss()">Maybe later</button>
      <app-button (clicked)="onStartWorkout()">Start my first workout</app-button>
    }
  </div>
</app-modal>
