<app-page-container title="Statistics" subtitle="Track your training progress">
  @if (workoutService.completedWorkouts().length > 0) {
    <!-- Summary Stats -->
    <div class="stats-grid">
      <app-card>
        <div class="stat-card">
          <div class="stat-card__icon stat-card__icon--primary">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14.4 14.4 9.6 9.6"></path>
              <path d="M18.657 21.485a2 2 0 1 1-2.829-2.828l-1.767 1.768a2 2 0 1 1-2.829-2.829l6.364-6.364a2 2 0 1 1 2.829 2.829l-1.768 1.767a2 2 0 1 1 2.828 2.829z"></path>
            </svg>
          </div>
          <div class="stat-card__content">
            <span class="stat-card__value">{{ statisticsService.totalWorkouts() }}</span>
            <span class="stat-card__label">Total Workouts</span>
          </div>
        </div>
      </app-card>

      <app-card>
        <div class="stat-card">
          <div class="stat-card__icon stat-card__icon--success">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline>
              <polyline points="16 7 22 7 22 13"></polyline>
            </svg>
          </div>
          <div class="stat-card__content">
            <span class="stat-card__value">{{ formatVolume(statisticsService.totalVolume()) }}</span>
            <span class="stat-card__label">Total Volume</span>
          </div>
        </div>
      </app-card>

      <app-card>
        <div class="stat-card">
          <div class="stat-card__icon stat-card__icon--warning">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2v4"></path>
              <path d="m16.2 7.8 2.9-2.9"></path>
              <path d="M18 12h4"></path>
              <path d="m16.2 16.2 2.9 2.9"></path>
              <path d="M12 18v4"></path>
              <path d="m4.9 19.1 2.9-2.9"></path>
              <path d="M2 12h4"></path>
              <path d="m4.9 4.9 2.9 2.9"></path>
            </svg>
          </div>
          <div class="stat-card__content">
            <span class="stat-card__value">{{ statisticsService.currentStreak() }}</span>
            <span class="stat-card__label">Day Streak</span>
          </div>
        </div>
      </app-card>

      <app-card>
        <div class="stat-card">
          <div class="stat-card__icon stat-card__icon--danger">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
          </div>
          <div class="stat-card__content">
            <span class="stat-card__value">{{ formatDuration(statisticsService.averageWorkoutDuration()) }}</span>
            <span class="stat-card__label">Avg Duration</span>
          </div>
        </div>
      </app-card>
    </div>

    <!-- Progressive Overload Suggestions -->
    @if (actionableSuggestions().length > 0) {
      <div class="section overload-section">
        <h3 class="section-title">Progressive Overload</h3>
        <div class="overload-grid">
          @for (suggestion of actionableSuggestions(); track suggestion.exerciseTemplateId) {
            <div class="overload-card" [class.overload-card--weight]="suggestion.suggestionType === 'increase_weight'" [class.overload-card--reps]="suggestion.suggestionType === 'increase_reps'">
              <div class="overload-card__header">
                <span class="overload-card__exercise">{{ suggestion.exerciseName }}</span>
                <span class="overload-card__confidence overload-card__confidence--{{ suggestion.confidence }}">{{ suggestion.confidence }}</span>
              </div>
              <div class="overload-card__body">
                <span class="overload-card__current">{{ getCurrentLabel(suggestion) }}</span>
                <svg class="overload-card__arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                  <polyline points="12 5 19 12 12 19"></polyline>
                </svg>
                <span class="overload-card__suggested">{{ getSuggestionLabel(suggestion) }}</span>
              </div>
              <p class="overload-card__reason">{{ suggestion.reason }}</p>
            </div>
          }
        </div>
      </div>
    }

    <!-- Plateau Alerts -->
    @if (plateauAlerts().length > 0) {
      <div class="section overload-section">
        <h3 class="section-title">Plateau Alerts</h3>
        <div class="overload-grid">
          @for (alert of plateauAlerts(); track alert.exerciseTemplateId) {
            <div class="overload-card overload-card--warning">
              <div class="overload-card__header">
                <span class="overload-card__exercise">{{ alert.exerciseName }}</span>
                <span class="overload-card__confidence overload-card__confidence--medium">{{ alert.weeksSinceProgress }}w</span>
              </div>
              <div class="overload-card__body">
                <span class="overload-card__current">No progress in {{ alert.weeksSinceProgress }} weeks</span>
                <span class="overload-card__suggested">{{ alert.currentMaxWeight }} {{ settingsService.weightUnit() }}</span>
              </div>
              <p class="overload-card__reason">{{ alert.suggestion }}</p>
            </div>
          }
        </div>
      </div>
    }

    <!-- Weekly Volume Chart (Simple Bar Chart) -->
    <app-card class="chart-card">
      <h3 class="chart-title">Weekly Volume Trend</h3>
      <div class="simple-chart">
        @for (data of volumeTrend; track data.label) {
          <div class="chart-bar-container">
            <div
              class="chart-bar"
              [style.height.%]="getBarHeight(data.volume, maxVolume)"
              [title]="data.volume + ' kg'"
            ></div>
            <span class="chart-bar-label">{{ data.label }}</span>
          </div>
        }
      </div>
    </app-card>

    <!-- Workout Frequency Chart -->
    <app-card class="chart-card">
      <h3 class="chart-title">Workouts per Week</h3>
      <div class="simple-chart">
        @for (data of frequencyTrend; track data.week) {
          <div class="chart-bar-container">
            <div
              class="chart-bar chart-bar--green"
              [style.height.%]="getBarHeight(data.count, maxFrequency)"
              [title]="data.count + ' workouts'"
            ></div>
            <span class="chart-bar-label">{{ data.week }}</span>
          </div>
        }
      </div>
    </app-card>

    <!-- Muscle Group Distribution -->
    <app-card class="chart-card">
      <h3 class="chart-title">Muscle Group Distribution</h3>
      <div class="muscle-groups">
        @for (data of muscleGroupData(); track data.muscleGroup) {
          <div class="muscle-group-item">
            <div class="muscle-group-item__header">
              <span class="muscle-group-item__name">{{ data.label }}</span>
              <span class="muscle-group-item__value">{{ data.setCount }} sets ({{ data.percentage }}%)</span>
            </div>
            <div class="muscle-group-item__bar">
              <div
                class="muscle-group-item__fill"
                [style.width.%]="data.percentage"
              ></div>
            </div>
          </div>
        }
      </div>
    </app-card>

    <!-- Exercise Progress Chart -->
    <app-card class="chart-card">
      <div class="exercise-progress-header">
        <h3 class="chart-title">Exercise Progress</h3>
        <select
          class="exercise-select"
          [ngModel]="selectedExerciseId()"
          (ngModelChange)="selectExercise($event)"
        >
          <option value="">Select an exercise</option>
          @for (exercise of exercisesWithHistory(); track exercise.id) {
            <option [value]="exercise.id">{{ exercise.name }}</option>
          }
        </select>
      </div>

      @if (selectedExerciseProgress()) {
        <div class="progress-chart-container">
          <!-- Chart Type Toggle -->
          <div class="chart-type-toggle">
            <button
              class="toggle-btn"
              [class.toggle-btn--active]="chartType() === 'weight'"
              (click)="chartType.set('weight')"
            >
              Max Weight
            </button>
            <button
              class="toggle-btn"
              [class.toggle-btn--active]="chartType() === 'e1rm'"
              (click)="chartType.set('e1rm')"
            >
              Est. 1RM
            </button>
            <button
              class="toggle-btn"
              [class.toggle-btn--active]="chartType() === 'volume'"
              (click)="chartType.set('volume')"
            >
              Volume
            </button>
          </div>

          <!-- Line Chart -->
          <div class="line-chart">
            <div class="line-chart__y-axis">
              <span>{{ getYAxisMax() }}</span>
              <span>{{ getYAxisMid() }}</span>
              <span>0</span>
            </div>
            <div class="line-chart__content">
              <svg class="line-chart__svg" viewBox="0 0 100 100" preserveAspectRatio="none">
                <!-- Grid lines -->
                <line x1="0" y1="50" x2="100" y2="50" class="grid-line" />

                <!-- Progress line -->
                <polyline
                  [attr.points]="getChartPoints()"
                  class="progress-line"
                  fill="none"
                />

                <!-- Data points -->
                @for (point of getDataPoints(); track point.index) {
                  <circle
                    [attr.cx]="point.x"
                    [attr.cy]="point.y"
                    r="2"
                    class="data-point"
                  >
                    <title>{{ point.label }}: {{ point.value }} {{ chartType() === 'volume' ? 'kg' : settingsService.weightUnit() }}</title>
                  </circle>
                }
              </svg>
              <div class="line-chart__x-axis">
                @for (label of getXAxisLabels(); track label) {
                  <span>{{ label }}</span>
                }
              </div>
            </div>
          </div>

          <!-- Progress Summary -->
          <div class="progress-summary">
            @if (getProgressChange() !== null) {
              <div class="progress-stat">
                <span class="progress-stat__label">Progress</span>
                <span
                  class="progress-stat__value"
                  [class.progress-stat__value--positive]="getProgressChange()! > 0"
                  [class.progress-stat__value--negative]="getProgressChange()! < 0"
                >
                  {{ getProgressChange()! > 0 ? '+' : '' }}{{ getProgressChange() }}%
                </span>
              </div>
            }
            <div class="progress-stat">
              <span class="progress-stat__label">Sessions</span>
              <span class="progress-stat__value">{{ selectedExerciseProgress()!.dataPoints.length }}</span>
            </div>
            <div class="progress-stat">
              <span class="progress-stat__label">Best {{ chartType() === 'weight' ? 'Weight' : chartType() === 'e1rm' ? '1RM' : 'Volume' }}</span>
              <span class="progress-stat__value">{{ getBestValue() }} {{ chartType() === 'volume' ? 'kg' : settingsService.weightUnit() }}</span>
            </div>
          </div>
        </div>
      } @else {
        <div class="no-exercise-selected">
          <p>Select an exercise to view your progress over time</p>
        </div>
      }
    </app-card>

    <!-- Personal Records -->
    <div class="section">
      <h3 class="section-title">Personal Records</h3>
      @if (workoutService.personalRecords().length > 0) {
        <div class="pr-columns">
          <!-- Max Weight Column -->
          <div class="pr-column">
            <h4 class="pr-column__title">Max Weight</h4>
            <div class="pr-list">
              @for (pr of getMaxWeightPRs(); track pr.id) {
                <div class="pr-row">
                  <span class="pr-row__exercise">{{ pr.exerciseName }}</span>
                  <div class="pr-row__value">
                    <span class="pr-row__number">{{ formatPrValue(pr) }}</span>
                    <span class="pr-row__unit">{{ settingsService.weightUnit() }}</span>
                    @if (pr.reps) {
                      <span class="pr-row__reps">&#64; {{ pr.reps }}</span>
                    }
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Estimated 1RM Column -->
          <div class="pr-column">
            <h4 class="pr-column__title">Estimated 1RM</h4>
            <div class="pr-list">
              @for (pr of getEstimated1RMPRs(); track pr.id) {
                <div class="pr-row">
                  <span class="pr-row__exercise">{{ pr.exerciseName }}</span>
                  <div class="pr-row__value">
                    <span class="pr-row__number">{{ formatPrValue(pr) }}</span>
                    <span class="pr-row__unit">{{ settingsService.weightUnit() }}</span>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      } @else {
        <p class="no-data">Complete more workouts to see your personal records!</p>
      }
    </div>
  } @else {
    <app-empty-state
      title="No Data Yet"
      description="Complete your first workout to start tracking your statistics!"
    >
      <div empty-icon>
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <line x1="12" y1="20" x2="12" y2="10"></line>
          <line x1="18" y1="20" x2="18" y2="4"></line>
          <line x1="6" y1="20" x2="6" y2="16"></line>
        </svg>
      </div>
      <app-button routerLink="/workout" [queryParams]="{ start: 'true' }">Start Workout</app-button>
    </app-empty-state>
  }
</app-page-container>
