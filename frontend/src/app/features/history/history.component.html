<app-page-container title="History" subtitle="Your workout history">
  @if (workoutService.isLoading() || isLoadingPage()) {
    <!-- Loading Skeletons -->
    <div class="skeleton-container">
      <app-skeleton variant="card"></app-skeleton>
      <app-skeleton variant="card"></app-skeleton>
      <app-skeleton variant="card"></app-skeleton>
    </div>
  } @else if (workoutGroups().length > 0 || viewMode() === 'calendar') {
    <!-- Stats Summary -->
    <div class="stats-row">
      <div class="stat-item">
        <span class="stat-item__value">{{ workoutService.totalWorkouts() }}</span>
        <span class="stat-item__label">Total Workouts</span>
      </div>
      <div class="stat-item">
        <span class="stat-item__value">{{ workoutService.getWorkoutStreak() }}</span>
        <span class="stat-item__label">Current Streak</span>
      </div>
      <div class="stat-item">
        <span class="stat-item__value">{{ workoutService.getLongestStreak() }}</span>
        <span class="stat-item__label">Best Streak</span>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="view-toggle">
        <button
          class="view-toggle__btn"
          [class.view-toggle__btn--active]="viewMode() === 'list'"
          (click)="toggleView('list')"
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="8" y1="6" x2="21" y2="6"></line>
            <line x1="8" y1="12" x2="21" y2="12"></line>
            <line x1="8" y1="18" x2="21" y2="18"></line>
            <line x1="3" y1="6" x2="3.01" y2="6"></line>
            <line x1="3" y1="12" x2="3.01" y2="12"></line>
            <line x1="3" y1="18" x2="3.01" y2="18"></line>
          </svg>
          List
        </button>
        <button
          class="view-toggle__btn"
          [class.view-toggle__btn--active]="viewMode() === 'calendar'"
          (click)="toggleView('calendar')"
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          Calendar
        </button>
      </div>
      <button class="export-btn" (click)="exportCsv()" title="Export workout history as CSV">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Export
      </button>
    </div>

    @if (allHistoryTags().length > 0) {
      <div class="tag-filter-row">
        @for (tag of allHistoryTags(); track tag) {
          <button
            class="tag-filter-chip"
            [class.tag-filter-chip--active]="activeTagFilter() === tag"
            (click)="toggleTagFilter(tag)"
          >{{ tag }}</button>
        }
      </div>
    }

    @if (viewMode() === 'calendar') {
      <!-- Calendar View -->
      <div class="calendar">
        <!-- Month Navigation -->
        <div class="calendar__nav">
          <button class="calendar__nav-btn" (click)="previousMonth()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>
          <span class="calendar__month-label">{{ selectedMonthLabel() }}</span>
          <button class="calendar__nav-btn" (click)="nextMonth()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
          <button class="calendar__today-btn" (click)="goToToday()">Today</button>
        </div>

        <!-- Weekday Headers -->
        <div class="calendar__grid">
          @for (day of weekDays; track day) {
            <div class="calendar__weekday">{{ day }}</div>
          }

          <!-- Day Cells -->
          @for (week of calendarWeeks(); track $index) {
            @for (day of week; track day.dateKey) {
              <button
                class="calendar__day"
                [class.calendar__day--outside]="!day.isCurrentMonth"
                [class.calendar__day--today]="day.isToday"
                [class.calendar__day--selected]="selectedDate() === day.dateKey"
                [class.calendar__day--has-workout]="day.workoutCount === 1 && day.isCurrentMonth"
                [class.calendar__day--has-workouts-many]="day.workoutCount >= 2 && day.isCurrentMonth"
                [disabled]="!day.isCurrentMonth || day.workoutCount === 0"
                (click)="selectDate(day)"
              >
                <span class="calendar__day-number">{{ day.dayNumber }}</span>
                @if (day.workoutCount > 0 && day.isCurrentMonth) {
                  <span class="calendar__day-dot"></span>
                }
              </button>
            }
          }
        </div>

        <!-- Selected Day Detail -->
        @if (selectedDate() && selectedDateWorkouts().length > 0) {
          <div class="calendar__detail">
            <h3 class="calendar__detail-title">{{ formatSelectedDate(selectedDate()!) }}</h3>
            <div class="calendar__detail-list">
              @for (workout of selectedDateWorkouts(); track workout.id) {
                <app-card [interactive]="true">
                  <a [routerLink]="['/history', workout.id]" class="workout-item">
                    <div class="workout-item__header">
                      <h4 class="workout-item__name">{{ workout.name }}</h4>
                      <span class="workout-item__date">{{ formatDate(workout.completedAt!) }}</span>
                    </div>
                    <div class="workout-item__details">
                      <div class="workout-item__stat">
                        <span class="workout-item__stat-value">{{ workout.exerciseCount ?? workout.exercises.length }}</span>
                        <span class="workout-item__stat-label">exercises</span>
                      </div>
                      <div class="workout-item__stat">
                        <span class="workout-item__stat-value">{{ workout.totalSets }}</span>
                        <span class="workout-item__stat-label">sets</span>
                      </div>
                      <div class="workout-item__stat">
                        <span class="workout-item__stat-value">{{ formatVolume(workout.totalVolume) }}</span>
                        <span class="workout-item__stat-label">volume</span>
                      </div>
                      <div class="workout-item__stat">
                        <span class="workout-item__stat-value">{{ formatDuration(workout.duration || 0) }}</span>
                        <span class="workout-item__stat-label">duration</span>
                      </div>
                    </div>
                    @if (workout.exercises.length) {
                      <div class="workout-item__exercises">
                        @for (exercise of workout.exercises.slice(0, 3); track exercise.id) {
                          <app-badge [size]="'sm'">{{ exercise.exerciseName }}</app-badge>
                        }
                        @if (workout.exercises.length > 3) {
                          <app-badge [size]="'sm'" [variant]="'default'">+{{ workout.exercises.length - 3 }}</app-badge>
                        }
                      </div>
                    }
                  </a>
                </app-card>
              }
            </div>
          </div>
        }
      </div>
    } @else {
      <!-- List View -->
      <div class="workout-groups">
        @for (group of filteredWorkoutGroups(); track group.label) {
          <div class="workout-group">
            <h3 class="workout-group__title">{{ group.label }}</h3>
            <div class="workout-group__list">
              @for (workout of group.workouts; track workout.id) {
                <app-card [interactive]="true">
                  <a [routerLink]="['/history', workout.id]" class="workout-item">
                    <div class="workout-item__header">
                      <h4 class="workout-item__name">{{ workout.name }}</h4>
                      <span class="workout-item__date">{{ formatDate(workout.completedAt!) }}</span>
                    </div>
                    <div class="workout-item__details">
                      <div class="workout-item__stat">
                        <span class="workout-item__stat-value">{{ workout.exerciseCount ?? workout.exercises.length }}</span>
                        <span class="workout-item__stat-label">exercises</span>
                      </div>
                      <div class="workout-item__stat">
                        <span class="workout-item__stat-value">{{ workout.totalSets }}</span>
                        <span class="workout-item__stat-label">sets</span>
                      </div>
                      <div class="workout-item__stat">
                        <span class="workout-item__stat-value">{{ formatVolume(workout.totalVolume) }}</span>
                        <span class="workout-item__stat-label">volume</span>
                      </div>
                      <div class="workout-item__stat">
                        <span class="workout-item__stat-value">{{ formatDuration(workout.duration || 0) }}</span>
                        <span class="workout-item__stat-label">duration</span>
                      </div>
                    </div>
                    @if (workout.exercises.length) {
                      <div class="workout-item__exercises">
                        @for (exercise of workout.exercises.slice(0, 3); track exercise.id) {
                          <app-badge [size]="'sm'">{{ exercise.exerciseName }}</app-badge>
                        }
                        @if (workout.exercises.length > 3) {
                          <app-badge [size]="'sm'" [variant]="'default'">+{{ workout.exercises.length - 3 }}</app-badge>
                        }
                      </div>
                    }
                    @if (workout.tags?.length) {
                      <div class="workout-item__tags">
                        @for (tag of workout.tags!; track tag) {
                          <span class="workout-item-tag">{{ tag }}</span>
                        }
                      </div>
                    }
                  </a>
                </app-card>
              }
            </div>
          </div>
        }
      </div>

      <!-- Pagination -->
      @if (totalPages() > 1) {
        <div class="pagination">
          <button
            class="pagination__btn"
            [disabled]="currentPage() === 1"
            (click)="loadPage(currentPage() - 1)"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            Previous
          </button>
          <span class="pagination__info">
            Page {{ currentPage() }} of {{ totalPages() }}
          </span>
          <button
            class="pagination__btn"
            [disabled]="currentPage() === totalPages()"
            (click)="loadPage(currentPage() + 1)"
          >
            Next
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
        </div>
      }
    }
  } @else {
    <app-empty-state
      title="No Workouts Yet"
      description="Complete your first workout to start tracking your progress!"
    >
      <div empty-icon>
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
      </div>
      <app-button routerLink="/workout" [queryParams]="{ start: 'true' }">Start Workout</app-button>
    </app-empty-state>
  }
</app-page-container>
